<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SapFlow Probe: measure.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SapFlow Probe
   </div>
   <div id="projectbrief">A low-cost HRM probe for measuring a tree&#39;s water consumption</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('measure_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">measure.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="pinout_8h_source.html">pinout.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="schedule_8h_source.html">schedule.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sd__log_8h_source.html">sd_log.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="weight_8h_source.html">weight.h</a>&quot;</code><br />
<code>#include &lt;Adafruit_MAX31865.h&gt;</code><br />
</div>
<p><a href="measure_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structtemperature.html">temperature</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stores a tuple of temperature values.  <a href="structtemperature.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:afc5c05d720c1d630ce94867c7bed9419"><td class="memItemLeft" align="right" valign="top"><a id="afc5c05d720c1d630ce94867c7bed9419"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#afc5c05d720c1d630ce94867c7bed9419">Rnom</a>&#160;&#160;&#160;100.0</td></tr>
<tr class="memdesc:afc5c05d720c1d630ce94867c7bed9419"><td class="mdescLeft">&#160;</td><td class="mdescRight">Nominal RTD resistance in ohms. <br /></td></tr>
<tr class="separator:afc5c05d720c1d630ce94867c7bed9419"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02208b322fb84b00331888e078a3f387"><td class="memItemLeft" align="right" valign="top"><a id="a02208b322fb84b00331888e078a3f387"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a02208b322fb84b00331888e078a3f387">Rref</a>&#160;&#160;&#160;430.0</td></tr>
<tr class="memdesc:a02208b322fb84b00331888e078a3f387"><td class="mdescLeft">&#160;</td><td class="mdescRight">Nominal reference resistor in ohms. <br /></td></tr>
<tr class="separator:a02208b322fb84b00331888e078a3f387"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a736b6b102918fbaaf3e4c538c8cb54dc"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a736b6b102918fbaaf3e4c538c8cb54dc">measure</a> (struct pt *pt=&amp;<a class="el" href="measure_8h.html#ada9fca85b63952a68f6a2158e5f8a87b">measure_thd</a>)</td></tr>
<tr class="memdesc:a736b6b102918fbaaf3e4c538c8cb54dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Captures a measurement from the three probes.  <a href="measure_8h.html#a736b6b102918fbaaf3e4c538c8cb54dc">More...</a><br /></td></tr>
<tr class="separator:a736b6b102918fbaaf3e4c538c8cb54dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3aecc8e0022fdfd26a57e4d31e59c479"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a3aecc8e0022fdfd26a57e4d31e59c479">sample_timer</a> (struct pt *pt=&amp;<a class="el" href="measure_8h.html#ac1b4a8786e0684b0f63f527522e11e5e">sample_timer_thd</a>)</td></tr>
<tr class="memdesc:a3aecc8e0022fdfd26a57e4d31e59c479"><td class="mdescLeft">&#160;</td><td class="mdescRight">Controls timing of the measurements.  <a href="measure_8h.html#a3aecc8e0022fdfd26a57e4d31e59c479">More...</a><br /></td></tr>
<tr class="separator:a3aecc8e0022fdfd26a57e4d31e59c479"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac0696e1dd57526aabd51d770895f4516"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#ac0696e1dd57526aabd51d770895f4516">baseline</a> (struct pt *pt=&amp;<a class="el" href="measure_8h.html#a75797b818bbb902f6d65e98df6ed77f1">baseline_thd</a>)</td></tr>
<tr class="memdesc:ac0696e1dd57526aabd51d770895f4516"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates baseline temperature.  <a href="measure_8h.html#ac0696e1dd57526aabd51d770895f4516">More...</a><br /></td></tr>
<tr class="separator:ac0696e1dd57526aabd51d770895f4516"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acbb9387a9490e6eeae2df75084467d76"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#acbb9387a9490e6eeae2df75084467d76">delta</a> (struct pt *pt=&amp;<a class="el" href="measure_8h.html#a8ff6579d0f5410dbe20162392e32d3a4">delta_thd</a>)</td></tr>
<tr class="memdesc:acbb9387a9490e6eeae2df75084467d76"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates temperature delta and sapflow.  <a href="measure_8h.html#acbb9387a9490e6eeae2df75084467d76">More...</a><br /></td></tr>
<tr class="separator:acbb9387a9490e6eeae2df75084467d76"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5adfa4fbf2b2c72857690502d53d4332"><td class="memItemLeft" align="right" valign="top"><a id="a5adfa4fbf2b2c72857690502d53d4332"></a>
static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a></td></tr>
<tr class="memdesc:a5adfa4fbf2b2c72857690502d53d4332"><td class="mdescLeft">&#160;</td><td class="mdescRight">global flag for synchronizing live data processing. Set by <a class="el" href="measure_8h.html#a3aecc8e0022fdfd26a57e4d31e59c479" title="Controls timing of the measurements.">sample_timer()</a> <br /></td></tr>
<tr class="separator:a5adfa4fbf2b2c72857690502d53d4332"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d17fc054558b632bff51e6b7e1448a7"><td class="memItemLeft" align="right" valign="top"><a id="a7d17fc054558b632bff51e6b7e1448a7"></a>
static struct <a class="el" href="structtemperature.html">temperature</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a></td></tr>
<tr class="memdesc:a7d17fc054558b632bff51e6b7e1448a7"><td class="mdescLeft">&#160;</td><td class="mdescRight">The most recent temperature reading, measured by the <a class="el" href="measure_8h.html#a736b6b102918fbaaf3e4c538c8cb54dc" title="Captures a measurement from the three probes.">measure()</a> protothread. <br /></td></tr>
<tr class="separator:a7d17fc054558b632bff51e6b7e1448a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ae301ecb99002f1951a9781941eae54"><td class="memItemLeft" align="right" valign="top"><a id="a6ae301ecb99002f1951a9781941eae54"></a>
static struct <a class="el" href="structtemperature.html">temperature</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a></td></tr>
<tr class="memdesc:a6ae301ecb99002f1951a9781941eae54"><td class="mdescLeft">&#160;</td><td class="mdescRight">The baseline temperature reading, computed by the <a class="el" href="measure_8h.html#ac0696e1dd57526aabd51d770895f4516" title="Calculates baseline temperature.">baseline()</a> protothread. <br /></td></tr>
<tr class="separator:a6ae301ecb99002f1951a9781941eae54"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ada9fca85b63952a68f6a2158e5f8a87b"><td class="memItemLeft" align="right" valign="top"><a id="ada9fca85b63952a68f6a2158e5f8a87b"></a>
static struct pt&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#ada9fca85b63952a68f6a2158e5f8a87b">measure_thd</a></td></tr>
<tr class="memdesc:ada9fca85b63952a68f6a2158e5f8a87b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Protothread control structure for <a class="el" href="measure_8h.html#a736b6b102918fbaaf3e4c538c8cb54dc" title="Captures a measurement from the three probes.">measure()</a> <br /></td></tr>
<tr class="separator:ada9fca85b63952a68f6a2158e5f8a87b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac1b4a8786e0684b0f63f527522e11e5e"><td class="memItemLeft" align="right" valign="top"><a id="ac1b4a8786e0684b0f63f527522e11e5e"></a>
static struct pt&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#ac1b4a8786e0684b0f63f527522e11e5e">sample_timer_thd</a></td></tr>
<tr class="memdesc:ac1b4a8786e0684b0f63f527522e11e5e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Protothread control structure for <a class="el" href="measure_8h.html#a3aecc8e0022fdfd26a57e4d31e59c479" title="Controls timing of the measurements.">sample_timer()</a> <br /></td></tr>
<tr class="separator:ac1b4a8786e0684b0f63f527522e11e5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a75797b818bbb902f6d65e98df6ed77f1"><td class="memItemLeft" align="right" valign="top"><a id="a75797b818bbb902f6d65e98df6ed77f1"></a>
static struct pt&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a75797b818bbb902f6d65e98df6ed77f1">baseline_thd</a></td></tr>
<tr class="memdesc:a75797b818bbb902f6d65e98df6ed77f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Protothread control structure for <a class="el" href="measure_8h.html#ac0696e1dd57526aabd51d770895f4516" title="Calculates baseline temperature.">baseline()</a> <br /></td></tr>
<tr class="separator:a75797b818bbb902f6d65e98df6ed77f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ff6579d0f5410dbe20162392e32d3a4"><td class="memItemLeft" align="right" valign="top"><a id="a8ff6579d0f5410dbe20162392e32d3a4"></a>
static struct pt&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8h.html#a8ff6579d0f5410dbe20162392e32d3a4">delta_thd</a></td></tr>
<tr class="memdesc:a8ff6579d0f5410dbe20162392e32d3a4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Protothread control structure for <a class="el" href="measure_8h.html#acbb9387a9490e6eeae2df75084467d76" title="Calculates temperature delta and sapflow.">delta()</a> <br /></td></tr>
<tr class="separator:a8ff6579d0f5410dbe20162392e32d3a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="ac0696e1dd57526aabd51d770895f4516"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac0696e1dd57526aabd51d770895f4516">&#9670;&nbsp;</a></span>baseline()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int baseline </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#a75797b818bbb902f6d65e98df6ed77f1">baseline_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates baseline temperature. </p>
<p>This is a protothread that averages 10 samples of data to determine the "initial" or "baseline" temperature of the tree. It should be used before the heater is turned on.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00072">72</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  PT_BEGIN(pt);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  Serial.print(<span class="stringliteral">&quot;Initializing baseline thread... &quot;</span>);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="comment">// Declare persistant variable for this thread</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="comment">// Initialize the baseline (reference) temperature</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> = 0;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> = 0;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  Serial.println(<span class="stringliteral">&quot;Done&quot;</span>);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordflow">for</span>(i = 0; i &lt; 10; ++i){</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    PT_WAIT_UNTIL(pt, <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a>);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    PT_WAIT_WHILE(pt, <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a>);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> += <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a>;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> += <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  }<span class="keywordflow">while</span>(millis()&lt;(pt)-&gt;t);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> /= i;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> /= i;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;Baseline: &quot;</span>&lt;&lt;<a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a>&lt;&lt;<span class="stringliteral">&quot;, &quot;</span>&lt;&lt;<a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a>&lt;&lt;endl;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  PT_END(pt);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acbb9387a9490e6eeae2df75084467d76"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acbb9387a9490e6eeae2df75084467d76">&#9670;&nbsp;</a></span>delta()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int delta </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#a8ff6579d0f5410dbe20162392e32d3a4">delta_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates temperature delta and sapflow. </p>
<p>This is a protothread that calculates the sap flow by averaging measurements over 40 seconds. It also calls other functions to get the weight, package the data, log to an SD card, and send the information over LoRa.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00096">96</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;{</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  PT_BEGIN(pt);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  Serial.print(<span class="stringliteral">&quot;Initializing delta thread... &quot;</span>);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="comment">// Declare persistent variables for this thread</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">float</span> flow;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  maxtemp = <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a43924fc35c8cda01bfb6fb6ae07f1a9b">heater</a>; <span class="comment">// This should be the heater peak temperature</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="comment">// Initialize the flow value</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  flow = 0;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  Serial.println(<span class="stringliteral">&quot;Done&quot;</span>);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordflow">for</span>(i = 0; i &lt; 5; ++i ){</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    PT_WAIT_UNTIL(pt, <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a>);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    PT_WAIT_WHILE(pt, <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a>);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="comment">// Ratio of upper delta over lower delta</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="keywordtype">float</span> udelt = <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> - <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a>;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordtype">float</span> ldelt = <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> - <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a>;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a> &lt;&lt; <span class="stringliteral">&quot;Delta: &quot;</span> &lt;&lt; udelt &lt;&lt;<span class="stringliteral">&quot;, &quot;</span> &lt;&lt; ldelt &lt;&lt; endl;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    flow += udelt / ldelt;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  };</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;Finished measurements.&quot;</span>&lt;&lt;endl;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  flow /= i;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  flow = log(flow) * (3600.*2e-6/7e-3);</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;Flow is &quot;</span>&lt;&lt;flow&lt;&lt;endl;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="comment">// Write the sapflow to the file.</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;Opening logfile...&quot;</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  ofstream sapfile = ofstream(<span class="stringliteral">&quot;demo.csv&quot;</span>, ios::out | ios::app);</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;Done&quot;</span>&lt;&lt;endl;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordtype">char</span> * time = <a class="code" href="schedule_8h.html#a4c06781bd70442b43eec7c92d3e7ea3a">rtc_ds</a>.now().text();</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <span class="keywordtype">char</span> * weight = <a class="code" href="weight_8h.html#a4ef767eaa983293099496709a036c5a6">read_weight</a>();</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a> &lt;&lt; time &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  &lt;&lt; <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  &lt;&lt; <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  &lt;&lt; flow &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  sapfile &lt;&lt; time &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>&lt;&lt; <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  &lt;&lt; <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>&lt;&lt; flow &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>&lt;&lt; weight</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  &lt;&lt; endl;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  sapfile.close();</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <a class="code" href="lora_8h.html#a5406703a916059feeaac0ce650e6ceb7">lora_init</a>();</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <a class="code" href="lora_8h.html#a081e4c64303e45009a39fd81bdf5eb7f">build_msg</a>(flow, weight, <a class="code" href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a>, maxtemp);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <a class="code" href="lora_8h.html#a759190db192ee81162c88decd75d3a7d">send_msg</a>();</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  PT_END(pt);</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a736b6b102918fbaaf3e4c538c8cb54dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a736b6b102918fbaaf3e4c538c8cb54dc">&#9670;&nbsp;</a></span>measure()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int measure </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#ada9fca85b63952a68f6a2158e5f8a87b">measure_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Captures a measurement from the three probes. </p>
<p>This is a protothread that reads the temperature from three RTD amplifiers connected to the probes in the tree. It stores the result in the global variable "latest", and logs to the SD card.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00021">21</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;{</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  PT_BEGIN(pt);</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  Serial.print(<span class="stringliteral">&quot;Initializing measurement thread... &quot;</span>);</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  <span class="keyword">static</span> Adafruit_MAX31865 upper_rtd = Adafruit_MAX31865(A5);</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  <span class="keyword">static</span> Adafruit_MAX31865 lower_rtd = Adafruit_MAX31865(A4);</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  <span class="keyword">static</span> Adafruit_MAX31865 heater_rtd = Adafruit_MAX31865(A3);</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  upper_rtd.begin(MAX31865_2WIRE);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  lower_rtd.begin(MAX31865_2WIRE);</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  heater_rtd.begin(MAX31865_2WIRE);</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  Serial.println(<span class="stringliteral">&quot;Done&quot;</span>);</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  PT_YIELD(pt);</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  <span class="keywordflow">while</span>(1)</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  {      </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    <span class="comment">// Wait for next sample trigger</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    PT_WAIT_UNTIL(pt, (<a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a> || <a class="code" href="schedule_8h.html#a88fe278e9285d43b598ce0f2c1ea0672">sleep</a>));</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="comment">// Check if we prepare for sleep</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="schedule_8h.html#a88fe278e9285d43b598ce0f2c1ea0672">sleep</a> )</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    {</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;      <span class="comment">// This seems to never be called.</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;      Serial.println(<span class="stringliteral">&quot;Sleeping&quot;</span>);</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;      PT_WAIT_WHILE(pt, <a class="code" href="schedule_8h.html#a88fe278e9285d43b598ce0f2c1ea0672">sleep</a>); <span class="comment">// sleep occurs here</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    }</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    PT_WAIT_WHILE(pt, <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a>);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">//Serial.println(&quot;Sampling...&quot;);</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">// Get the latest temperature</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> = upper_rtd.temperature(<a class="code" href="measure_8h.html#afc5c05d720c1d630ce94867c7bed9419">Rnom</a>, <a class="code" href="measure_8h.html#a02208b322fb84b00331888e078a3f387">Rref</a>);</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> = lower_rtd.temperature(<a class="code" href="measure_8h.html#afc5c05d720c1d630ce94867c7bed9419">Rnom</a>, <a class="code" href="measure_8h.html#a02208b322fb84b00331888e078a3f387">Rref</a>);</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a43924fc35c8cda01bfb6fb6ae07f1a9b">heater</a> = heater_rtd.temperature(<a class="code" href="measure_8h.html#afc5c05d720c1d630ce94867c7bed9419">Rnom</a>, <a class="code" href="measure_8h.html#a02208b322fb84b00331888e078a3f387">Rref</a>);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    DateTime t = <a class="code" href="schedule_8h.html#a4c06781bd70442b43eec7c92d3e7ea3a">rtc_ds</a>.now();</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">// Print to Serial terminal</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a> &lt;&lt; <span class="stringliteral">&quot;Upper: &quot;</span> &lt;&lt; <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> &lt;&lt; <span class="stringliteral">&quot; Lower: &quot;</span> </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    &lt;&lt; <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> &lt;&lt; <span class="stringliteral">&quot; Heater: &quot;</span> &lt;&lt;<a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a43924fc35c8cda01bfb6fb6ae07f1a9b">heater</a> </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    &lt;&lt; <span class="stringliteral">&quot; Time: &quot;</span> &lt;&lt; t.text() &lt;&lt; endl;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">// Save calculated sapflow</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;Logfile...&quot;</span>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    ofstream logfile = ofstream(<span class="stringliteral">&quot;demo_log.csv&quot;</span>, </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                                     ios::out | ios::app );</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;opened...&quot;</span>;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    logfile &lt;&lt; t.text() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    logfile &lt;&lt; setw(6) &lt;&lt; <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">upper</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    &lt;&lt; setw(6) &lt;&lt; <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">lower</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    &lt;&lt; setw(6) &lt;&lt; <a class="code" href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a>.<a class="code" href="structtemperature.html#a43924fc35c8cda01bfb6fb6ae07f1a9b">heater</a> &lt;&lt; endl;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    logfile.close(); <span class="comment">// Ensure the file is closed</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <a class="code" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a>&lt;&lt;<span class="stringliteral">&quot;done&quot;</span>&lt;&lt;endl;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  PT_END(pt);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3aecc8e0022fdfd26a57e4d31e59c479"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3aecc8e0022fdfd26a57e4d31e59c479">&#9670;&nbsp;</a></span>sample_timer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sample_timer </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#ac1b4a8786e0684b0f63f527522e11e5e">sample_timer_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Controls timing of the measurements. </p>
<p>This is a protothread that creates a pulse every second on the global variable sample_trigger in order to sychronize sample-based processing. Protothreads that sample or process sampled data can latch this signal using PT_WAIT_UNTIL(pt, sample_trigger); PT_WAIT_WHILE(pt, sample_trigger); to synchronize execution without impacting the sample frequency.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00006">6</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;{</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  PT_BEGIN(pt);</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  Serial.println(<span class="stringliteral">&quot;Initialized timer thread&quot;</span>);</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  <span class="keywordflow">while</span>(1)</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  {</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="comment">// Serial.println(&quot;Trigger&quot;);</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    PT_YIELD(pt); <span class="comment">// Give everyone a chance to see the trigger</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    <a class="code" href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a> = <span class="keyword">false</span>; <span class="comment">// Clear the trigger</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    PT_TIMER_DELAY(pt,1000); <span class="comment">// Sample every 1000ms</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  }</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  PT_END(pt);</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="astructtemperature_html_a43924fc35c8cda01bfb6fb6ae07f1a9b"><div class="ttname"><a href="structtemperature.html#a43924fc35c8cda01bfb6fb6ae07f1a9b">temperature::heater</a></div><div class="ttdeci">float heater</div><div class="ttdoc">Temperature (Celcius) at the heater probe.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00023">measure.h:23</a></div></div>
<div class="ttc" id="alora_8h_html_a759190db192ee81162c88decd75d3a7d"><div class="ttname"><a href="lora_8h.html#a759190db192ee81162c88decd75d3a7d">send_msg</a></div><div class="ttdeci">void send_msg(void)</div><div class="ttdoc">Sends a LoRa packet to the base station.</div><div class="ttdef"><b>Definition:</b> <a href="lora_8cpp_source.html#l00083">lora.cpp:83</a></div></div>
<div class="ttc" id="aschedule_8h_html_a4c06781bd70442b43eec7c92d3e7ea3a"><div class="ttname"><a href="schedule_8h.html#a4c06781bd70442b43eec7c92d3e7ea3a">rtc_ds</a></div><div class="ttdeci">static RTC_DS3231 rtc_ds</div><div class="ttdoc">Instance of our real-time clock.</div><div class="ttdef"><b>Definition:</b> <a href="schedule_8h_source.html#l00010">schedule.h:10</a></div></div>
<div class="ttc" id="astructtemperature_html_a95ed2f6ae8c6927b0fcebe281b5229e5"><div class="ttname"><a href="structtemperature.html#a95ed2f6ae8c6927b0fcebe281b5229e5">temperature::upper</a></div><div class="ttdeci">float upper</div><div class="ttdoc">Temperature (Celcius) at the upper probe.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00021">measure.h:21</a></div></div>
<div class="ttc" id="ameasure_8h_html_a5adfa4fbf2b2c72857690502d53d4332"><div class="ttname"><a href="measure_8h.html#a5adfa4fbf2b2c72857690502d53d4332">sample_trigger</a></div><div class="ttdeci">static bool sample_trigger</div><div class="ttdoc">global flag for synchronizing live data processing. Set by sample_timer()</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00010">measure.h:10</a></div></div>
<div class="ttc" id="ameasure_8h_html_a6ae301ecb99002f1951a9781941eae54"><div class="ttname"><a href="measure_8h.html#a6ae301ecb99002f1951a9781941eae54">reference</a></div><div class="ttdeci">static struct temperature reference</div><div class="ttdoc">The baseline temperature reading, computed by the baseline() protothread.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00027">measure.h:27</a></div></div>
<div class="ttc" id="alora_8h_html_a5406703a916059feeaac0ce650e6ceb7"><div class="ttname"><a href="lora_8h.html#a5406703a916059feeaac0ce650e6ceb7">lora_init</a></div><div class="ttdeci">void lora_init(void)</div><div class="ttdoc">Initialize the LoRa radio.</div><div class="ttdef"><b>Definition:</b> <a href="lora_8cpp_source.html#l00017">lora.cpp:17</a></div></div>
<div class="ttc" id="aweight_8h_html_a4ef767eaa983293099496709a036c5a6"><div class="ttname"><a href="weight_8h.html#a4ef767eaa983293099496709a036c5a6">read_weight</a></div><div class="ttdeci">char * read_weight(char *buffer=weight_buf, int len=20)</div><div class="ttdoc">Gets the weight from the scale.</div><div class="ttdef"><b>Definition:</b> <a href="weight_8cpp_source.html#l00004">weight.cpp:4</a></div></div>
<div class="ttc" id="alora_8h_html_a081e4c64303e45009a39fd81bdf5eb7f"><div class="ttname"><a href="lora_8h.html#a081e4c64303e45009a39fd81bdf5eb7f">build_msg</a></div><div class="ttdeci">void build_msg(float flow, char *weight, float temp, float maxtemp)</div><div class="ttdoc">Builds a JSON string to send over LoRa.</div><div class="ttdef"><b>Definition:</b> <a href="lora_8cpp_source.html#l00058">lora.cpp:58</a></div></div>
<div class="ttc" id="astructtemperature_html_aaf995f56734f6afd2fa4b062a00d72ec"><div class="ttname"><a href="structtemperature.html#aaf995f56734f6afd2fa4b062a00d72ec">temperature::lower</a></div><div class="ttdeci">float lower</div><div class="ttdoc">Temperature (Celcius) at the lower probe.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00022">measure.h:22</a></div></div>
<div class="ttc" id="asd__log_8h_html_ab9da93331bae3f5268bcaf01ab44d31d"><div class="ttname"><a href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout</a></div><div class="ttdeci">static ArduinoOutStream cout(Serial)</div><div class="ttdoc">Allows use of streams to print to Serial via cout.</div></div>
<div class="ttc" id="ameasure_8h_html_a02208b322fb84b00331888e078a3f387"><div class="ttname"><a href="measure_8h.html#a02208b322fb84b00331888e078a3f387">Rref</a></div><div class="ttdeci">#define Rref</div><div class="ttdoc">Nominal reference resistor in ohms.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00013">measure.h:13</a></div></div>
<div class="ttc" id="ameasure_8h_html_afc5c05d720c1d630ce94867c7bed9419"><div class="ttname"><a href="measure_8h.html#afc5c05d720c1d630ce94867c7bed9419">Rnom</a></div><div class="ttdeci">#define Rnom</div><div class="ttdoc">Nominal RTD resistance in ohms.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00012">measure.h:12</a></div></div>
<div class="ttc" id="ameasure_8h_html_a7d17fc054558b632bff51e6b7e1448a7"><div class="ttname"><a href="measure_8h.html#a7d17fc054558b632bff51e6b7e1448a7">latest</a></div><div class="ttdeci">static struct temperature latest</div><div class="ttdoc">The most recent temperature reading, measured by the measure() protothread.</div><div class="ttdef"><b>Definition:</b> <a href="measure_8h_source.html#l00026">measure.h:26</a></div></div>
<div class="ttc" id="aschedule_8h_html_a88fe278e9285d43b598ce0f2c1ea0672"><div class="ttname"><a href="schedule_8h.html#a88fe278e9285d43b598ce0f2c1ea0672">sleep</a></div><div class="ttdeci">static bool sleep</div><div class="ttdoc">Global flag to prep for sleep.</div><div class="ttdef"><b>Definition:</b> <a href="schedule_8h_source.html#l00012">schedule.h:12</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="measure_8h.html">measure.h</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
